@startuml Feature_GererComptesUtilisateurs_Sequence
title Feature: Gerer les comptes utilisateurs (Admin) (sequence)
actor Administrateur
participant "Front Web" as Front
participant "Route" as Route
participant "Controller" as Controller
participant "Model" as Model
database "Base de donnees" as BDD

== Consulter liste des utilisateurs ==
Administrateur -> Front: Acceder a "Gestion utilisateurs"
Front -> Route: GET /admin/users?page=1&limit=20&filter=all
Route -> Controller: adminController.getUsers(req, res)
Controller -> Controller: Verifier authentification JWT
Controller -> Controller: Verifier role = 'administrator'

alt Non administrateur
Controller --> Route: 403 + "Acces refuse"
Route --> Front: 403 + message
Front --> Administrateur: Rediriger vers accueil
else Administrateur autorise
Controller -> Controller: Valider parametres\n(page, limit, filter: all/active/inactive)
Controller -> Model: userModel.countUsers(filter)
Model -> BDD: SELECT COUNT(*) as total\nFROM user\nWHERE (is_active = ? OR ? IS NULL)
BDD --> Model: Nombre total
Model --> Controller: totalResults

Controller -> Model: userModel.getUsers(filter, limit, offset)
Model -> BDD: SELECT u.user_id, u.username,\nu.email, u.registration_date,\nu.role, u.is_active,\n(SELECT COUNT(*) FROM library WHERE user_id = u.user_id) as game_count,\n(SELECT COUNT(*) FROM comment WHERE user_id = u.user_id) as comment_count\nFROM user u\nWHERE (u.is_active = ? OR ? IS NULL)\nORDER BY u.registration_date DESC\nLIMIT ? OFFSET ?
BDD --> Model: Liste utilisateurs avec stats
Model --> Controller: Utilisateurs

Controller -> Controller: Calculer metadonnees pagination

Controller --> Route: 200 + utilisateurs + pagination
Route --> Front: 200 + donnees
Front --> Administrateur: Afficher liste utilisateurs\navec options actions
end

== Consulter detail utilisateur ==
Administrateur -> Front: Cliquer sur utilisateur
Front -> Route: GET /admin/users/:user_id
Route -> Controller: adminController.getUserDetail(req, res)
Controller -> Controller: Verifier authentification\net role administrator

Controller -> Model: userModel.getUserById(user_id)
Model -> BDD: SELECT * FROM user\nWHERE user_id = ?
BDD --> Model: Infos utilisateur
Model --> Controller: Donnees utilisateur

Controller -> Model: libraryModel.getUserStats(user_id)
Model -> BDD: SELECT\nCOUNT(*) as total_games,\nCOUNT(CASE WHEN status = 'completed' THEN 1 END) as completed_games,\nSUM(play_time) as total_play_time\nFROM library\nWHERE user_id = ?
BDD --> Model: Statistiques bibliotheque
Model --> Controller: Stats jeux

Controller -> Model: commentModel.countUserComments(user_id)
Model -> BDD: SELECT COUNT(*) as total\nFROM comment WHERE user_id = ?
BDD --> Model: Nombre commentaires
Model --> Controller: Stats commentaires

Controller -> Model: reportModel.getReportsAboutUser(user_id)
Model -> BDD: SELECT COUNT(*) as report_count\nFROM report\nWHERE content_type = 'user'\nAND content_id = ?
BDD --> Model: Nombre signalements
Model --> Controller: Stats signalements

Controller --> Route: 200 + profil complet + stats
Route --> Front: 200 + donnees
Front --> Administrateur: Afficher profil detaille\navec historique et actions

== Desactiver un compte ==
Administrateur -> Front: Cliquer sur "Desactiver compte"
Front --> Administrateur: Demander confirmation
Administrateur -> Front: Confirmer
Front -> Route: PATCH /admin/users/:user_id/disable
Route -> Controller: adminController.disableUser(req, res)
Controller -> Controller: Verifier authentification\net role administrator

alt Tentative de se desactiver soi-meme
Controller --> Route: 400 + "Impossible de se desactiver soi-meme"
Route --> Front: 400 + message
Front --> Administrateur: Afficher erreur
else Utilisateur different
Controller -> Model: userModel.disableUser(user_id)
Model -> BDD: UPDATE user\nSET is_active = FALSE\nWHERE user_id = ?
BDD --> Model: Mise a jour effectuee
Model --> Controller: Compte desactive
Controller --> Route: 200 + "Compte desactive"
Route --> Front: 200 + confirmation
Front --> Administrateur: Afficher succes\n+ mettre a jour affichage
end

== Reactiver un compte ==
Administrateur -> Front: Cliquer sur "Reactiver compte"
Front -> Route: PATCH /admin/users/:user_id/activate
Route -> Controller: adminController.activateUser(req, res)
Controller -> Controller: Verifier authentification\net role administrator

Controller -> Model: userModel.activateUser(user_id)
Model -> BDD: UPDATE user\nSET is_active = TRUE\nWHERE user_id = ?
BDD --> Model: Mise a jour effectuee
Model --> Controller: Compte reactive
Controller --> Route: 200 + "Compte reactive"
Route --> Front: 200 + confirmation
Front --> Administrateur: Afficher succes\n+ mettre a jour affichage

== Changer role utilisateur ==
Administrateur -> Front: Cliquer sur "Modifier role"
Front --> Administrateur: Afficher options\n(member, administrator)
Administrateur -> Front: Selectionner et confirmer
Front -> Route: PATCH /admin/users/:user_id/role + new_role
Route -> Controller: adminController.changeUserRole(req, res)
Controller -> Controller: Verifier authentification\net role administrator

alt Tentative de modifier son propre role
Controller --> Route: 400 + "Impossible de modifier son propre role"
Route --> Front: 400 + message
Front --> Administrateur: Afficher erreur
else Utilisateur different
Controller -> Model: userModel.updateRole(user_id, new_role)
Model -> BDD: UPDATE user\nSET role = ?\nWHERE user_id = ?
BDD --> Model: Mise a jour effectuee
Model --> Controller: Role modifie
Controller --> Route: 200 + "Role mis a jour"
Route --> Front: 200 + confirmation
Front --> Administrateur: Afficher succes\n+ mettre a jour affichage
end

alt Erreur BDD
Model --> Controller: Erreur BDD
Controller --> Route: 500 + message
Route --> Front: 500 + message
Front --> Administrateur: Afficher message d'erreur
end
@enduml
